<solid-user>
  ;) Hey
</solid-user>

<script type="module">
  import tag from 'https://thelanding.page/tag/tag.js'
  import solidClientAuthentication from './packages/solid-client-authn-browser.js'

  import handleKonami from './tags/konami-kid.js'
  import createWindowPane from './tags/window-pane.js'

  const { html, get, on, set, css } = tag('solid-user', { sessionInfo: {} })

  const session = new solidClientAuthentication.Session()
  session.handleIncomingRedirect(window.location.href)
    .then(sessionInfo => set({ sessionInfo }))

  export function getSessionInfo() {
    return get().sessionInfo
  }

  export function connect(event) {
    event.preventDefault()
    const { isLoggedIn } = get().sessionInfo

    if(session.login && !isLoggedIn) {
      session.login({
        redirectUrl: window.location.href,
        oidcIssuer: 'https://broker.pod.inrupt.com/',
      });
    }
  }

  export function disconnect() {
    session.logout()
    set({ sessionInfo: {} })
  }

  on('click', '#in', connect)
  on('click', '#out', disconnect)

  html(() => {
    const { webId, isLoggedIn } = getSessionInfo()

    const name = isLoggedIn ? ':) Friend' : ':/ Stranger'
    const action = isLoggedIn
      ? `<button id="out">Disconnect</button>`
      : `<a id="in" href="https://broker.pod.inrupt.com/">Connect</a>`

    return `
      ${name}
      ${webId ? webId : '' }
      ${action}
    `
  })

  css(`
    & {
      background: deepskyblue;
      border-radius: 4px;
      display: inline-block;
      font-weight: bold;
      padding: 8px;
    }

    & button {
      margin-inline-start: 10px;
    }
  `)

  handleKonami(() => {
    const doors = createWindowPane('5071D-44xX04', 'Solid Developer Tools', `
      <ul>
        <li>
          <a href="https://penny.vincenttunru.com/" target="_blank">
            Penny
          </a>
        </li>
        <li>
          <a href="https://forum.solidproject.org/" target="_blank">
            Solid Project Forums
          </a>
        </li>
      </ul>
    `)

    document.body.insertAdjacentHTML("beforeend", doors)
  })
</script>

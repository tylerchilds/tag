<!doctype html>
<html lang="">
  <head>
    <meta charset="utf-8">
    <title>Tag</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="//cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">

    <style type="text/css">
      @font-face {
        font-family: 'BerkeleyMono';
        src: url('BerkeleyMonoVariable-Regular.ttf') format("truetype-variations");
        font-weight: 100 700;
      }

      @font-face {
        font-family: 'BerkeleyMono';
        src: url('BerkeleyMonoVariable-Italic.ttf') format("truetype-variations");
        font-style: italic;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

			html, body { height: 100%; }

			html,
			body {
				background: black;
				box-sizing: border-box;
				color: orange;
				font-family: 'BerkeleyMono';
			}

			body {
				border: 1px solid orange;
				width: calc(100% - 2px);
			}

			hr {
				background: green;
			}

			a:link {
				color: white !important;
			}

			a:visited {
				color: orange !important;
			}
    </style>
  </head>

  <body>
    <manuscript id="index"></manuscript>

    <script type="module">
      import Quill from 'https://esm.sh/quill@1.3.6'
      import tag from './tag.bundle.js'
      window.tag = tag

      const path = window.location.pathname
      const hostname = window.location.hostname

      const ENV = {
        PROD: 'production',
        DEV: 'development',
        SAFE: 'safe'
      }

      const env = {
        prod: 'production',
        dev: 'development',
        SAFE: 'safe'
      }

      const environments = {
        "": ENV.SAFE,
        "localhost": ENV.DEV,
      }

      const flags = {
        mode: environments[hostname] || ENV.PROD,

        path: path.split('/').slice(0, -1).join('/'),
        syncInterval: 30000 // every 30 seconds
      }

      const emptyEditor = {
        delta: {},
        rawHTML: ""
      }

      const $ = tag('manuscript')

      mount($, flags)
      berkeley($, flags)

      function mount($, flags) {
        $.mount((target) => {
          $.ready(() => initialize(target, $, flags))
        })
      }

      function initialize(target, $, flags) {
        const { id } = target
        const { delta, rawHTML, mode } = editorById(id)

        if(mode === 'view') {
          return rawHTML
        }

        editor(target, delta)
				target.editor.focus()
      }

      function editor(target, delta) {
        if(! target.editor) {
          const container = document.createElement('div')
          target.appendChild(container)

          target.editor = new Quill(container, { theme: 'bubble' })
          target.editor.setContents(delta)
          target.editor.on('editor-change', update(target))
        }
      }

      function update(target) {
        const { id } = target

        return function updateEditor() {
          const delta = target.editor.getContents()
          const rawHTML = target.editor.root.innerHTML

					console.log(rawHTML)

          $.write({
            [id]: { delta, rawHTML }
          })
        }
      }

      export function editorById(id) {
        return $.read()[id] || emptyEditor
      }

      function berkeley($, flags) {
        $.style(`
					& {
						display: block;
            font-family: 'BerkeleyMono';
					}
          & .ql-toolbar.ql-bubble,
          & .ql-container.ql-bubble,
          & .ql-toolbar.ql-snow,
          & .ql-container.ql-snow {
            font-family: 'BerkeleyMono';
						font-weight: 100;
					}
					& .ql-header {
						position: relative;
					}
        `)
      }
    </script>
		<style>
			/* scanlines */
			html::after {
				content: " ";
				display: block;
				position: fixed;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
				background: rgba(18, 16, 16, 0.1);
				opacity: 0;
				z-index: 2;
				pointer-events: none;
			}
			html::before {
				content: " ";
				display: block;
				position: fixed;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
				background: linear-gradient(rgba(255, 255, 255, .2) 50%, rgba(0, 0, 0, 0) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
				z-index: 2;
				background-size: 100% 2px, 3px 100%;
				pointer-events: none;
			}
    </style>
  </body>
</html>
